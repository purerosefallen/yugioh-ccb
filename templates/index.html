<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ´ æ¸¸æˆç‹CCB</title>
  <style>
    .github-link {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
    .github-link img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      margin: 2px 4px 2px 0;
      border-radius: 12px;
      font-size: 0.9em;
      font-weight: 500;
      vertical-align: middle;
    }
    .tag-green   { background: #c8e6c9; color: #1b5e20; }
    .tag-yellow  { background: #fff9c4; color: #665c00; }
    .tag-gray    { background: #e0e0e0; color: #424242; }
    .tag-red     { background: #ffcdd2; color: #b71c1c; }
    body { font-family: sans-serif; margin: 2em; background: #f5f5f5; }
    input[type="text"] { width: 400px; padding: 10px; font-size: 16px; }
    ul#suggestions {
      list-style: none; margin: 0; padding: 0; width: 400px;
      border: 1px solid #ccc; background: #fff;
      position: absolute; z-index: 10; max-height: 200px; overflow-y: auto;
    }
    ul#suggestions li { padding: 8px; cursor: pointer; }
    ul#suggestions li:hover { background-color: #f0f0f0; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td {
      border: 1px solid #999; padding: 6px 10px; text-align: center;
    }
    .match { background-color: #c8e6c9; }
    .partial { background-color: #fff9c4; }
    .mismatch { background-color: #ffcdd2; }
    button { margin-left: 8px; }
    .hint-box {
      margin: 1em 0;
      padding: 0.5em;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 4px;
      color: #856404;
    }
    .arrow-grid {
      display: grid;
      grid-template-rows: repeat(3, 1.5em);
      grid-template-columns: repeat(3, 1.5em);
      gap: 2px;
    }
    .arrow-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .arrow-cell.empty {
      border: none;
      background: transparent;
    }
    .arrow-cell.cell-green { background: #c8e6c9; }
    .arrow-cell.cell-red   { background: #ffcdd2; }
    .arrow-cell.cell-black { background: #eeeeee; }


    .tag {
      display: inline-block;
      padding: 2px 6px;
      margin: 1px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .tag-green  { background: #c8e6c9; }
    .tag-yellow { background: #fff9c4; }
    .tag-gray   { background: #eee; }
    .tag-red    { background: #ffcdd2; }
  </style>
</head>
<body>
  <div class="github-link">
    <a href="https://github.com/EN1AK/yugioh-ccb" target="_blank" rel="noopener">
      <img src="https://avatars.githubusercontent.com/EN1AK" alt="GitHub">
    </a>
  </div>
  <h1>ğŸ´ æ¸¸æˆç‹CCB</h1>
  <form method="POST" style="margin-bottom:1em;">
    <label>é¢˜åº“ï¼š
      <select name="mode">
        <option value="monster" {% if mode =='monster' %}selected{% endif %}>
          æ€ªå…½å¡ï¼ˆæ— é€šå¸¸ï¼‰
        </option>
        <option value="spell"   {% if mode =='spell'   %}selected{% endif %}>
          é­”æ³•å¡
        </option>
        <option value="trap"    {% if mode =='trap'    %}selected{% endif %}>
          é™·é˜±å¡
        </option>
        <option value="hot"     {% if mode =='hot'     %}selected{% endif %}>
          çƒ­é—¨å¡
        </option>
        <option value="all"     {% if mode =='all'     %}selected{% endif %}>
          æ‰€æœ‰å¡
        </option>
      </select>
    </label>
    <button type="submit" name="action" value="change_mode">åˆ‡æ¢é¢˜åº“</button>
  </form>


  <!-- å†å²çŒœæµ‹ -->
  {% if history %}
    <h2>å†å²çŒœæµ‹
      <small style="font-size:0.8em; color:#666;">
      ï¼ˆ{{ guess_count }} / {{ max_attempts }} ï¼‰
      </small>
    </h2>
    <table>
      <thead>
        <tr>
          <th>å¡å</th><th>æ”»å‡»</th><th>å®ˆå¤‡</th><th>ç­‰çº§/é˜¶çº§</th><th>åˆ»åº¦</th><th>ç®­å¤´</th>
          <th>ç±»å‹</th><th>å±æ€§</th><th>ç§æ—</th><th>æ•ˆæœæ ‡ç­¾</th><th>ç³»åˆ—</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in history %}
        <tr>
          <td>{{ entry.guess_name }}</td>
          <td>{{ entry.compare['æ”»å‡»']|safe }}</td>
          <td>{{ entry.compare['å®ˆå¤‡']|safe }}</td>
          <td>{{ entry.compare['ç­‰çº§/é˜¶çº§']|safe }}</td>
          <td>{{ entry.compare['åˆ»åº¦']|safe }}</td>
          <td>{{ entry.compare['ç®­å¤´']|safe }}</td>
          <td style="white-space: nowrap;">{{ entry.compare['ç±»å‹']|safe }}</td>
          <td style="white-space: nowrap;">{{ entry.compare['å±æ€§']|safe }}</td>
          <td style="white-space: nowrap;">{{ entry.compare['ç§æ—']|safe }}</td>
          <td style="white-space: nowrap;">{{ entry.compare['æ•ˆæœæ ‡ç­¾']|safe }}</td>
          <td style="white-space: nowrap;">{{ entry.compare['ç³»åˆ—']|safe }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <!-- è¾“å…¥ä¸æŒ‰é’® -->
  <form method="POST" autocomplete="off" style="position: relative; margin-top: 1em;">
    <input type="text" id="guess" name="guess" placeholder="è¾“å…¥å¡å" oninput="fetchSuggestions()" onfocus="fetchSuggestions()" />
    <input type="hidden" name="guess_id" id="guess_id" value="">
    <!-- ä¸‰ä¸ªåŠ¨ä½œæŒ‰é’® -->
    <button type="submit" name="action" value="guess">æäº¤çŒœæµ‹</button>
    <button type="submit" name="action" value="surrender">æŠ•é™</button>
    <button type="submit" name="action" value="restart">é‡æ–°å¼€å§‹</button>
    <ul id="suggestions" hidden></ul>
  </form>

  {% if hints %}
    <div class="hint-box">
      {% for h in hints %}
        <p>{{ h }}</p>
      {% endfor %}
    </div>
  {% endif %}

  <!-- æœ¬æ¬¡åé¦ˆ -->
  {% if feedback %}
    {% if feedback.error %}
      <p style="color:red; font-weight:bold;">{{ feedback.error }}</p>
    {% elif feedback.success %}
      <p style="color:green; font-weight:bold;">{{ feedback.success }}</p>
    {% elif feedback.giveup %}
      <p style="color:blue; font-weight:bold;">ğŸ’¡ æ”¾å¼ƒäº†ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š{{ feedback.answer }}</p>
    {% elif feedback.compare %}
      <h3>ä½ çŒœçš„æ˜¯ï¼š<strong>{{ feedback.guess_name }}</strong></h3>
      <table>
        <thead><tr><th>å±æ€§</th><th>ç»“æœ</th></tr></thead>
        <tbody>
        {% for k,v in feedback.compare.items() %}
          <tr><td>{{ k }}</td><td>{{ v|safe }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
  {% endif %}

  <script>
    function debounce(fn, delay) {
      let timeout = null;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
      };
    }
    async function _fetchSuggestions() {
      const input = document.getElementById("guess");
      const hid    = document.getElementById("guess_id");
      const sug    = document.getElementById("suggestions");
      const kw     = input.value.trim();
      if (!kw) { hid.value=""; sug.innerHTML=''; sug.hidden=true; return; }
      const resp = await fetch(`/suggest?q=${encodeURIComponent(kw)}`);
      const items = await resp.json();
      sug.innerHTML = '';
      if (!items.length) { sug.hidden = true; return; }
      for (const item of items) {
        const li = document.createElement('li');
        li.textContent = item.name;
        li.dataset.id = item.id;
        li.onclick = () => {
          input.value = item.name;
          hid.value   = item.id;
          sug.hidden  = true;
        };
        sug.appendChild(li);
      }
      sug.hidden = false;
    }
    const fetchSuggestions = debounce(_fetchSuggestions, 300);
    document.addEventListener('click', e => {
      if (!e.target.closest('#guess')) {
        document.getElementById("suggestions").hidden = true;
      }
    });
  </script>

</body>
</html>
