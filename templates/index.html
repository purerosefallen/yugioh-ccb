<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ´ æ¸¸æˆç‹CCB</title>
  <style>
    .tag {
      display: inline-block;
      padding: 2px 8px;
      margin: 2px 4px 2px 0;
      border-radius: 12px;
      font-size: 0.9em;
      font-weight: 500;
      vertical-align: middle;
    }
    .tag-green   { background: #c8e6c9; color: #1b5e20; }
    .tag-yellow  { background: #fff9c4; color: #665c00; }
    .tag-gray    { background: #e0e0e0; color: #424242; }
    .tag-red     { background: #ffcdd2; color: #b71c1c; }
    body { font-family: sans-serif; margin: 2em; background: #f5f5f5; }
    input[type="text"] { width: 400px; padding: 10px; font-size: 16px; }
    ul#suggestions {
      list-style: none; margin: 0; padding: 0; width: 400px;
      border: 1px solid #ccc; background: #fff;
      position: absolute; z-index: 10; max-height: 200px; overflow-y: auto;
    }
    ul#suggestions li { padding: 8px; cursor: pointer; }
    ul#suggestions li:hover { background-color: #f0f0f0; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td {
      border: 1px solid #999; padding: 6px 10px; text-align: center;
    }
    .match { background-color: #c8e6c9; }
    .partial { background-color: #fff9c4; }
    .mismatch { background-color: #ffcdd2; }
    button { margin-left: 8px; }

  </style>
</head>
<body>
  <h1>ğŸ´ æ¸¸æˆç‹CCB</h1>

  <!-- å†å²çŒœæµ‹ -->
  {% if history %}
    <h2>å†å²çŒœæµ‹</h2>
    <table>
      <thead>
        <tr>
          <th>å¡å</th><th>æ”»å‡»</th><th>å®ˆå¤‡</th><th>ç­‰çº§</th><th>åˆ»åº¦</th>
          <th>ç±»å‹</th><th>å±æ€§</th><th>ç§æ—</th><th>æ•ˆæœæ ‡ç­¾</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in history %}
        <tr>
          <td>{{ entry.guess_name }}</td>
          <td>{{ entry.compare['æ”»å‡»']|safe }}</td>
          <td>{{ entry.compare['å®ˆå¤‡']|safe }}</td>
          <td>{{ entry.compare['ç­‰çº§']|safe }}</td>
          <td>{{ entry.compare['åˆ»åº¦']|safe }}</td>
          <td style="white-space: nowrap;">{{ entry.compare['ç±»å‹']|safe }}</td>
          <td style="white-space: nowrap;">{{ entry.compare['å±æ€§']|safe }}</td>
          <td style="white-space: nowrap;">{{ entry.compare['ç§æ—']|safe }}</td>
          <td style="white-space: nowrap;">{{ entry.compare['æ•ˆæœæ ‡ç­¾']|safe }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <!-- è¾“å…¥ä¸æŒ‰é’® -->
  <form method="POST" autocomplete="off" style="position: relative; margin-top: 1em;">
    <input type="text" id="guess" name="guess" placeholder="è¾“å…¥å¡å" oninput="fetchSuggestions()" onfocus="fetchSuggestions()" />
    <!-- ä¸‰ä¸ªåŠ¨ä½œæŒ‰é’® -->
    <button type="submit" name="action" value="guess">æäº¤çŒœæµ‹</button>
    <button type="submit" name="action" value="surrender">æŠ•é™</button>
    <button type="submit" name="action" value="restart">é‡æ–°å¼€å§‹</button>
    <ul id="suggestions" hidden></ul>
  </form>

  <!-- æœ¬æ¬¡åé¦ˆ -->
  {% if feedback %}
    {% if feedback.error %}
      <p style="color:red; font-weight:bold;">{{ feedback.error }}</p>
    {% elif feedback.success %}
      <p style="color:green; font-weight:bold;">{{ feedback.success }}</p>
    {% elif feedback.giveup %}
      <p style="color:blue; font-weight:bold;">ğŸ’¡ æ”¾å¼ƒäº†ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š{{ feedback.answer }}</p>
    {% elif feedback.compare %}
      {% if feedback.hint %}
        <p style="color:blue;">ğŸ’¡ æç¤ºï¼šå¡åä¸­åŒ…å« â€œ{{ feedback.hint }}â€ è¿™ä¸ªå­—</p>
      {% endif %}
      <h3>ä½ çŒœçš„æ˜¯ï¼š<strong>{{ feedback.guess_name }}</strong></h3>
      <table>
        <thead><tr><th>å±æ€§</th><th>ç»“æœ</th></tr></thead>
        <tbody>
        {% for k,v in feedback.compare.items() %}
          <tr><td>{{ k }}</td><td>{{ v|safe }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
  {% endif %}

  <script>
    async function fetchSuggestions() {
      const input = document.getElementById("guess");
      const sug   = document.getElementById("suggestions");
      const kw    = input.value.trim();
      if (!kw) { sug.innerHTML=''; sug.hidden=true; return; }
      const resp = await fetch(`/suggest?q=${encodeURIComponent(kw)}`);
      const names = await resp.json();
      sug.innerHTML = '';
      if (!names.length) { sug.hidden = true; return; }
      for (const name of names) {
        const li = document.createElement('li');
        li.textContent = name;
        li.onclick = () => { input.value = name; sug.hidden = true; };
        sug.appendChild(li);
      }
      sug.hidden = false;
    }
    document.addEventListener('click', e => {
      if (!e.target.closest('#guess')) {
        document.getElementById("suggestions").hidden = true;
      }
    });
  </script>
</body>
</html>
